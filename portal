<!DOCTYPE html>
<html lang="ms">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>INSTAQLIM - Institut Tahfiz Al-Quran lil Muttaqin</title>
  <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&display=swap" rel="stylesheet">
  <style>
    :root { --primary: #10b981; --secondary: #f59e0b; --danger: #ef4444; --light: #f0fdf4; --dark: #1f2937;
      --warning: #f59e0b; --indigo: #6366f1; --red: #dc2626; --success: #10b981; }
    [data-theme="dark"] { --bg-color: #0f172a; --card-bg: #1e293b; --text-color: #e2e8f0; --border-color: #4a5568; --light: #1e293b; }
    * { margin:0; padding:0; box-sizing:border-box; }
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--light); color: #333; line-height: 1.6;
      background-image: radial-gradient(circle at top left, rgba(16,185,129,0.05) 0%, transparent 50%), radial-gradient(circle at bottom right, rgba(245,158,11,0.05) 0%, transparent 50%);
      position: relative; }
    body::before { content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0;
      background-image: linear-gradient(45deg, transparent 49%, rgba(16,185,129,0.03) 49%, rgba(16,185,129,0.03) 51%, transparent 51%),
                       linear-gradient(-45deg, transparent 49%, rgba(245,158,11,0.03) 49%, rgba(245,158,11,0.03) 51%, transparent 51%);
      background-size: 50px 50px; pointer-events: none; z-index: -1; }
    h1, h2, h3, .logo h2 { font-family: 'Amiri', serif; color: var(--primary); }
    header { background: linear-gradient(to right, var(--primary), #059669); color: white; padding: 1rem 0; position: relative; overflow: hidden; }
    header::after { content: "بِسْمِ ٱللَّٰهِ ٱلرَّحْمَٰنِ ٱلرَّحِيمِ"; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
      font-family: 'Amiri', serif; font-size: 4rem; opacity: 0.07; pointer-events: none; color: white; }
    .container { max-width: 1200px; margin: 0 auto; padding: 0 1rem; }
    .flex { display: flex; align-items: center; justify-content: space-between; }
    .btn-logout { background: var(--danger); color: white; padding: 0.5rem 1rem; border-radius: 5px; text-decoration: none; font-weight: 500; }
    main { padding: 2rem 0; }
    .card { background: var(--card-bg, white); border-radius: 10px; padding: 1.5rem; margin-bottom: 1.5rem; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1.5rem; margin-top: 1rem; }
    .menu-card { background: var(--primary); color: white; text-align: center; padding: 2rem; border-radius: 10px; cursor: pointer; transition: transform 0.3s, box-shadow 0.3s; }
    .menu-card:hover { transform: translateY(-10px); box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
    .menu-card i { font-size: 3rem; margin-bottom: 1rem; }
    table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
    th, td { padding: 0.75rem; text-align: left; border-bottom: 1px solid var(--border-color, #ddd); }
    th { background: var(--light); }
    .btn { padding: 0.5rem 1rem; border: none; border-radius: 5px; cursor: pointer; margin-right: 0.5rem; }
    .btn-primary { background: var(--primary); color: white; }
    .btn-success { background: var(--secondary); color: white; }
    .btn-danger { background: var(--danger); color: white; }
    .btn-edit { background: #f59e0b; color: white; }
    .form-group { margin-bottom: 1rem; }
    label { display: block; margin-bottom: 0.5rem; font-weight: 600; }
    input, textarea, select { width: 100%; padding: 0.75rem; border: 1px solid var(--border-color, #ccc); border-radius: 5px; background-color: var(--card-bg, white); color: var(--text-color, #333); }
    .hidden { display: none !important; }
    .login-container { max-width: 400px; margin: 5rem auto; padding: 2rem; background: var(--card-bg, white); border-radius: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
    .logo { text-align: center; margin-bottom: 2rem; font-size: 2rem; color: var(--primary); }
    #modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; z-index: 1000; }
    #modal > div { background: var(--card-bg, white); border-radius: 10px; padding: 1.5rem; width: 90%; max-width: 600px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); max-height: 90vh; overflow-y: auto; }
    .toast { position: fixed; bottom: 20px; right: 20px; padding: 15px 25px; background: var(--success); color: white; border-radius: 5px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); transform: translateY(100px); opacity: 0; transition: transform 0.3s, opacity 0.3s; z-index: 2000; }
    .toast.show { transform: translateY(0); opacity: 1; }
    .theme-toggle { position: fixed; bottom: 20px; left: 20px; background: var(--primary); color: white; border-radius: 50%; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 1000; }
  </style>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
</head>
<body>

  <!-- Login Page -->
  <div id="loginPage" class="login-container">
    <div class="logo">
      <img src="https://arleta.site/interactivelink/2950/Logo-Maahad.JPG" alt="Logo" style="width: 150px; margin-bottom: 1rem;">
      <h2>INSTAQLIM</h2>
      <p>Institut Tahfiz Al-Quran lil Muttaqin</p>
    </div>
    <h3 class="text-center">Log Masuk Sistem</h3>
    <div class="form-group"><label>Nama Pengguna</label><input type="text" id="username"/></div>
    <div class="form-group"><label>Kata Laluan</label><input type="password" id="password"/></div>
    <button class="btn btn-primary" style="width:100%" onclick="login()">Log Masuk</button>
  </div>

  <!-- Main App -->
  <div id="mainApp" class="hidden">
    <header>
      <div class="container flex">
        <h1>INSTAQLIM</h1>
        <div>
          <span>Selamat Datang, <strong id="userName"></strong> (<span id="userRole"></span>)</span>
          <a href="#" class="btn-logout" onclick="logout()">Log Keluar</a>
        </div>
      </div>
    </header>
    <div class="container">
      <main>
        <!-- Admin Dashboard -->
        <div id="adminDashboard" class="hidden">
          <h2 class="text-center">Papan Pemuka Pentadbir</h2>
          <div class="grid">
            <div class="menu-card" onclick="showSection('manageUsers')"><i class="fas fa-users"></i><h3>Pengurusan Pengguna</h3></div>
            <div class="menu-card" onclick="showSection('manageStudents')"><i class="fas fa-user-graduate"></i><h3>Pengurusan Pelajar</h3></div>
            <div class="menu-card" onclick="showSection('manageTeachers')"><i class="fas fa-chalkboard-teacher"></i><h3>Pengurusan Guru</h3></div>
            <div class="menu-card" onclick="showSection('manageStaff')"><i class="fas fa-users-cog"></i><h3>Pengurusan Kakitangan</h3></div>
            <div class="menu-card" onclick="showSection('manageClasses')"><i class="fas fa-door-open"></i><h3>Pengurusan Kelas</h3></div>
            <div class="menu-card" onclick="showSection('manageSchedule')"><i class="fas fa-calendar-alt"></i><h3>Jadual Waktu</h3></div>
            <div class="menu-card" onclick="showSection('studentAchievements')"><i class="fas fa-trophy"></i><h3>Pencapaian Pelajar</h3></div>
            <div class="menu-card" onclick="showSection('viewTeachingReports')"><i class="fas fa-file-alt"></i><h3>Laporan Mengajar</h3></div>
          </div>
        </div>

        <!-- Guru Dashboard -->
        <div id="guruDashboard" class="hidden">
          <h2 class="text-center">Papan Pemuka Guru</h2>
          <div class="grid">
            <div class="menu-card" onclick="showSection('viewSchedule')"><i class="fas fa-calendar-alt"></i><h3>Lihat Jadual</h3></div>
            <div class="menu-card" onclick="showSection('teachingReportForm')"><i class="fas fa-file-alt"></i><h3>Laporan Harian</h3></div>
            <div class="menu-card" onclick="showSection('viewTeachingReports')"><i class="fas fa-file-alt"></i><h3>Laporan Saya</h3></div>
          </div>
        </div>

        <!-- Sections -->
        <div id="sections" class="hidden">

          <!-- Pengurusan Pengguna -->
          <div id="manageUsers" class="card hidden">
            <h3>Pengurusan Pengguna Sistem</h3>
            <button class="btn btn-success" onclick="openAddUser()">+ Tambah Pengguna</button>
            <table id="userTable">
              <thead><tr><th>Username</th><th>Nama</th><th>Peranan</th><th>No. KP</th><th>Status</th><th>Tindakan</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>

          <!-- Pengurusan Pelajar -->
          <div id="manageStudents" class="card hidden">
            <h3>Pengurusan Pelajar</h3>
            <button class="btn btn-success" onclick="openAddStudent()">+ Tambah Pelajar</button>
            <table id="studentTable">
              <thead><tr><th>ID</th><th>Nama</th><th>No. KP</th><th>Kelas</th><th>Wali</th><th>No HP Wali</th><th>Tindakan</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>

          <!-- Pengurusan Guru -->
          <div id="manageTeachers" class="card hidden">
            <h3>Pengurusan Guru</h3>
            <button class="btn btn-success" onclick="openAddTeacher()">+ Tambah Guru</button>
            <table id="teacherTable">
              <thead><tr><th>ID</th><th>Nama</th><th>No. KP</th><th>Mata Pelajaran</th><th>No HP</th><th>Tindakan</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>

          <!-- Pengurusan Kakitangan -->
          <div id="manageStaff" class="card hidden">
            <h3>Pengurusan Kakitangan</h3>
            <button class="btn btn-success" onclick="openAddStaff()">+ Tambah Kakitangan</button>
            <table id="staffTable">
              <thead><tr><th>ID</th><th>Nama</th><th>No. KP</th><th>Jawatan</th><th>No HP</th><th>Tindakan</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>

          <!-- Pengurusan Kelas -->
          <div id="manageClasses" class="card hidden">
            <h3>Pengurusan Kelas</h3>
            <button class="btn btn-success" onclick="openAddClass()">+ Tambah Kelas</button>
            <table id="classTable">
              <thead><tr><th>ID</th><th>Nama Kelas</th><th>Guru Kelas</th><th>Tindakan</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>

          <!-- Pencapaian Pelajar -->
          <div id="studentAchievements" class="card hidden">
            <h3>Pencapaian Pelajar</h3>
            <button class="btn btn-success" onclick="openAddAchievement()">+ Tambah Pencapaian</button>
            <table id="achievementTable">
              <thead><tr><th>Pelajar</th><th>Pencapaian</th><th>Tarikh</th><th>Tindakan</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>

          <!-- Jadual Waktu Admin -->
          <div id="manageSchedule" class="card hidden">
            <h3>Jadual Waktu</h3>
            <button class="btn btn-success" onclick="saveSchedule()">Simpan Jadual</button>
            <table id="scheduleTable">
              <thead><tr><th>Waktu/Hari</th><th>Isnin</th><th>Selasa</th><th>Rabu</th><th>Khamis</th><th>Jumaat</th></tr></thead>
              <tbody>
                <tr><td>8:00-9:00</td><td><input type="text" data-row="0" data-col="0"></td><td><input type="text" data-row="0" data-col="1"></td><td><input type="text" data-row="0" data-col="2"></td><td><input type="text" data-row="0" data-col="3"></td><td><input type="text" data-row="0" data-col="4"></td></tr>
                <tr><td>9:00-10:00</td><td><input type="text" data-row="1" data-col="0"></td><td><input type="text" data-row="1" data-col="1"></td><td><input type="text" data-row="1" data-col="2"></td><td><input type="text" data-row="1" data-col="3"></td><td><input type="text" data-row="1" data-col="4"></td></tr>
                <tr><td>10:00-11:00</td><td><input type="text" data-row="2" data-col="0"></td><td><input type="text" data-row="2" data-col="1"></td><td><input type="text" data-row="2" data-col="2"></td><td><input type="text" data-row="2" data-col="3"></td><td><input type="text" data-row="2" data-col="4"></td></tr>
                <tr><td>11:00-12:00</td><td><input type="text" data-row="3" data-col="0"></td><td><input type="text" data-row="3" data-col="1"></td><td><input type="text" data-row="3" data-col="2"></td><td><input type="text" data-row="3" data-col="3"></td><td><input type="text" data-row="3" data-col="4"></td></tr>
                <tr><td>12:00-13:00</td><td><input type="text" data-row="4" data-col="0"></td><td><input type="text" data-row="4" data-col="1"></td><td><input type="text" data-row="4" data-col="2"></td><td><input type="text" data-row="4" data-col="3"></td><td><input type="text" data-row="4" data-col="4"></td></tr>
              </tbody>
            </table>
          </div>

          <!-- Lihat Jadual Guru -->
          <div id="viewSchedule" class="card hidden">
            <h3>Jadual Waktu Saya</h3>
            <table id="viewScheduleTable">
              <thead><tr><th>Waktu/Hari</th><th>Isnin</th><th>Selasa</th><th>Rabu</th><th>Khamis</th><th>Jumaat</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>

          <!-- Laporan Mengajar -->
          <div id="viewTeachingReports" class="card hidden">
            <h3>Laporan Mengajar Guru</h3>
            <div style="margin:1rem 0; text-align:right;">
              <button class="btn btn-print" onclick="window.print()">Cetak</button>
            </div>
            <div id="teachingReportPrintSection">
              <div class="report-header text-center">
                <img src="https://arleta.site/interactivelink/2950/Logo-Maahad.JPG" alt="Logo" style="width:120px;">
                <h2>Laporan Mengajar Harian Guru</h2>
                <p><strong>INSTAQLIM</strong> | Tarikh: <span id="printDate"></span></p>
              </div>
              <table id="teachingReportTable">
                <thead><tr><th>Bil</th><th>Guru</th><th>Tarikh</th><th>Kelas</th><th>Topik</th><th>Catatan</th></tr></thead>
                <tbody></tbody>
              </table>
            </div>
          </div>

          <!-- Form Laporan Mengajar -->
          <div id="teachingReportForm" class="card hidden">
            <h3>Laporan Mengajar Harian</h3>
            <div class="form-group"><label>Tarikh</label><input type="date" id="reportDate" required></div>
            <div class="form-group"><label>Kelas</label><select id="reportClass" required><option value="">Pilih Kelas</option></select></div>
            <div class="form-group"><label>Topik</label><input type="text" id="reportTopic" required></div>
            <div class="form-group"><label>Catatan</label><textarea id="reportNotes" rows="5" required></textarea></div>
            <button class="btn btn-success" onclick="saveTeachingReport()">Hantar Laporan</button>
          </div>

        </div>
      </main>
    </div>
  </div>

  <!-- Modal -->
  <div id="modal" class="hidden">
    <div>
      <h3 id="modalTitle">Tambah Data</h3>
      <div id="dataForm"></div>
      <div style="margin-top:1.5rem; text-align:right;">
        <button type="button" class="btn" onclick="closeModal()">Batal</button>
        <button type="button" class="btn btn-primary" id="saveBtn">Simpan</button>
      </div>
    </div>
  </div>

  <div id="toast" class="toast"></div>
  <div class="theme-toggle" onclick="toggleTheme()" title="Tukar Tema"><i class="fas fa-moon" id="themeIcon"></i></div>

  <script>
  const API_URL = 'https://script.google.com/macros/s/AKfycbyZE4UFh7V5V7Wak2chMN1Kz3kJjfXif_LRGlLkrweiC3X8qloJ-tjMhhJgb-uqHmsJ/exec'; // Ganti jika berubah

  let currentUser = null;
  let currentSection = '';
  let currentSaveFunction = null;

  let classes = [], students = [], teachers = [], staff = [], users = [], schedule = Array(5).fill().map(() => Array(5).fill(''));

  async function apiCall(action, payload = {}) {
    try {
      const res = await fetch(API_URL, {
        method: 'POST',
        body: JSON.stringify({ action, ...payload })
      });
      const data = await res.json();
      if (data.status !== 'success') throw new Error(data.message || 'Ralat server');
      return data;
    } catch (e) {
      showToast(e.message || 'Ralat sambungan', 'error');
      throw e;
    }
  }

  function showToast(msg, type = 'success') {
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.style.background = type === 'success' ? 'var(--success)' : 'var(--danger)';
    t.classList.add('show');
    setTimeout(() => t.classList.remove('show'), 4000);
  }

  function closeModal() {
    document.getElementById('modal').classList.add('hidden');
    document.getElementById('dataForm').innerHTML = '';
    currentSaveFunction = null;
  }

  // Login & Logout
  async function login() {
    const u = document.getElementById('username').value.trim();
    const p = document.getElementById('password').value;
    if (!u || !p) return showToast('Isi username dan kata laluan', 'error');
    try {
      const r = await apiCall('login', { username: u, password: p });
      currentUser = r.user;
      document.getElementById('loginPage').classList.add('hidden');
      document.getElementById('mainApp').classList.remove('hidden');
      document.getElementById('userName').textContent = r.user.name || u;
      document.getElementById('userRole').textContent = r.user.role === 'admin' ? 'Pentadbir' : 'Guru';
      document.getElementById('adminDashboard').classList.toggle('hidden', r.user.role !== 'admin');
      document.getElementById('guruDashboard').classList.toggle('hidden', r.user.role === 'admin');
      showToast('Log masuk berjaya');
    } catch (err) {
      showToast('Login gagal: ' + err.message, 'error');
    }
  }

  function logout() {
    if (confirm('Log keluar?')) {
      currentUser = null;
      document.getElementById('mainApp').classList.add('hidden');
      document.getElementById('loginPage').classList.remove('hidden');
    }
  }

  function showSection(id) {
    document.querySelectorAll('#sections > div').forEach(d => d.classList.add('hidden'));
    const sec = document.getElementById(id);
    if (sec) sec.classList.remove('hidden');
    document.getElementById('sections').classList.remove('hidden');
    currentSection = id;

    if (id === 'manageUsers') loadUsers();
    if (id === 'manageStudents') loadStudents();
    if (id === 'manageTeachers') loadTeachers();
    if (id === 'manageStaff') loadStaff();
    if (id === 'manageClasses') loadClasses();
    if (id === 'manageSchedule') loadSchedule();
    if (id === 'viewSchedule') loadViewSchedule();
    if (id === 'viewTeachingReports') loadTeachingReports();
    if (id === 'studentAchievements') loadAchievements();
  }

  // === PENGGUNA ===
  async function loadUsers() {
    try {
      const res = await apiCall('getUsers');
      users = res.users || [];
      const tbody = document.querySelector('#userTable tbody');
      tbody.innerHTML = '';
      users.forEach(u => {
        const roleText = u.role === 'admin' ? 'Pentadbir' : u.role === 'guru' ? 'Guru' : 'Kakitangan';
        tbody.innerHTML += `
          <tr>
            <td>${u.username}</td><td>${u.name}</td><td>${roleText}</td><td>${u.ic || '-'}</td><td>${u.status || 'active'}</td>
            <td>
              <button class="btn btn-edit" onclick="editUser('${u.id}')">Kemaskini</button>
              ${u.username !== 'admin' ? `<button class="btn btn-danger" onclick="deleteUser('${u.id}')">Padam</button>` : ''}
            </td>
          </tr>`;
      });
    } catch (err) {
      showToast(err.message, 'error');
    }
  }

  function openAddUser() {
    document.getElementById('modalTitle').textContent = 'Tambah Pengguna';
    document.getElementById('dataForm').innerHTML = `
      <div class="form-group"><label>Username</label><input type="text" id="u_username" required></div>
      <div class="form-group"><label>Kata Laluan</label><input type="password" id="u_password" required></div>
      <div class="form-group"><label>Nama Penuh</label><input type="text" id="u_name" required></div>
      <div class="form-group"><label>Peranan</label><select id="u_role" required>
        <option value="admin">Pentadbir</option>
        <option value="guru">Guru</option>
        <option value="staff">Kakitangan</option>
      </select></div>
      <input type="hidden" id="u_id">
    `;
    currentSaveFunction = saveUser;
    document.getElementById('modal').classList.remove('hidden');
  }

  function editUser(id) {
    const u = users.find(x => x.id === id);
    if (!u) return showToast('Pengguna tidak dijumpai', 'error');
    openAddUser();
    document.getElementById('modalTitle').textContent = 'Kemaskini Pengguna';
    document.getElementById('u_id').value = u.id;
    document.getElementById('u_username').value = u.username;
    document.getElementById('u_password').value = '';
    document.getElementById('u_name').value = u.name;
    document.getElementById('u_role').value = u.role;
  }

  async function saveUser() {
    const id = document.getElementById('u_id').value;
    const user = {
      id: id || undefined,
      username: document.getElementById('u_username').value.trim(),
      password: document.getElementById('u_password').value || undefined,
      name: document.getElementById('u_name').value.trim(),
      role: document.getElementById('u_role').value
    };
    if (!user.username || !user.name || !user.role) return showToast('Isi medan wajib', 'error');
    if (!id && !user.password) return showToast('Kata laluan diperlukan untuk pengguna baru', 'error');
    try {
      if (id) await apiCall('updateUser', { user });
      else await apiCall('addUser', { user });
      closeModal();
      await loadUsers();
      showToast('Pengguna berjaya disimpan');
    } catch (err) {
      showToast(err.message, 'error');
    }
  }

  async function deleteUser(id) {
    if (!confirm('Padam pengguna ini?')) return;
    try {
      await apiCall('deleteUser', { id });
      await loadUsers();
      showToast('Pengguna dipadam');
    } catch (err) {
      showToast(err.message, 'error');
    }
  }

  // === PELAJAR ===
  async function loadStudents() {
    try {
      const res = await apiCall('getStudents');
      students = res.students || [];
      const tbody = document.querySelector('#studentTable tbody');
      tbody.innerHTML = '';
      students.forEach(s => {
        tbody.innerHTML += `
          <tr>
            <td>${s.id}</td><td>${s.name}</td><td>${s.ic || '-'}</td><td>${s.class || '-'}</td><td>${s.guardian || '-'}</td><td>${s.guardianPhone || '-'}</td>
            <td>
              <button class="btn btn-edit" onclick="editStudent('${s.id}')">Kemaskini</button>
              <button class="btn btn-danger" onclick="deleteStudent('${s.id}')">Padam</button>
            </td>
          </tr>`;
      });
    } catch (err) {
      showToast(err.message, 'error');
    }
  }

  function openAddStudent() {
    document.getElementById('modalTitle').textContent = 'Tambah Pelajar';
    document.getElementById('dataForm').innerHTML = `
      <div class="form-group"><label>Nama</label><input type="text" id="s_name" required></div>
      <div class="form-group"><label>No. KP</label><input type="text" id="s_ic"></div>
      <div class="form-group"><label>Kelas</label><input type="text" id="s_class"></div>
      <div class="form-group"><label>Wali</label><input type="text" id="s_guardian"></div>
      <div class="form-group"><label>No HP Wali</label><input type="text" id="s_phone"></div>
      <input type="hidden" id="s_id">
    `;
    currentSaveFunction = saveStudent;
    document.getElementById('modal').classList.remove('hidden');
  }

  function editStudent(id) {
    const s = students.find(x => x.id === id);
    if (!s) return showToast('Pelajar tidak dijumpai', 'error');
    openAddStudent();
    document.getElementById('modalTitle').textContent = 'Kemaskini Pelajar';
    document.getElementById('s_id').value = s.id;
    document.getElementById('s_name').value = s.name;
    document.getElementById('s_ic').value = s.ic || '';
    document.getElementById('s_class').value = s.class || '';
    document.getElementById('s_guardian').value = s.guardian || '';
    document.getElementById('s_phone').value = s.guardianPhone || '';
  }

  async function saveStudent() {
    const id = document.getElementById('s_id').value;
    const student = {
      id: id || undefined,
      name: document.getElementById('s_name').value.trim(),
      ic: document.getElementById('s_ic').value.trim() || null,
      class: document.getElementById('s_class').value.trim() || null,
      guardian: document.getElementById('s_guardian').value.trim() || null,
      guardianPhone: document.getElementById('s_phone').value.trim() || null
    };
    if (!student.name) return showToast('Nama diperlukan', 'error');
    try {
      if (id) await apiCall('updateStudent', { student });
      else await apiCall('addStudent', { student });
      closeModal();
      await loadStudents();
      showToast('Pelajar berjaya disimpan');
    } catch (err) {
      showToast(err.message, 'error');
    }
  }

  async function deleteStudent(id) {
    if (!confirm('Padam pelajar ini?')) return;
    try {
      await apiCall('deleteStudent', { id });
      await loadStudents();
      showToast('Pelajar dipadam');
    } catch (err) {
      showToast(err.message, 'error');
    }
  }

  // === GURU ===
  async function loadTeachers() {
    try {
      const res = await apiCall('getTeachers');
      teachers = res.teachers || [];
      const tbody = document.querySelector('#teacherTable tbody');
      tbody.innerHTML = '';
      teachers.forEach(t => {
        tbody.innerHTML += `
          <tr>
            <td>${t.id}</td><td>${t.name}</td><td>${t.ic || '-'}</td><td>${t.subject || '-'}</td><td>${t.phone || '-'}</td>
            <td>
              <button class="btn btn-edit" onclick="editTeacher('${t.id}')">Kemaskini</button>
              <button class="btn btn-danger" onclick="deleteTeacher('${t.id}')">Padam</button>
            </td>
          </tr>`;
      });
    } catch (err) {
      showToast(err.message, 'error');
    }
  }

  function openAddTeacher() {
    document.getElementById('modalTitle').textContent = 'Tambah Guru';
    document.getElementById('dataForm').innerHTML = `
      <div class="form-group"><label>Nama</label><input type="text" id="t_name" required></div>
      <div class="form-group"><label>No. KP</label><input type="text" id="t_ic"></div>
      <div class="form-group"><label>Mata Pelajaran</label><input type="text" id="t_subject"></div>
      <div class="form-group"><label>No. HP</label><input type="text" id="t_phone"></div>
      <input type="hidden" id="t_id">
    `;
    currentSaveFunction = saveTeacher;
    document.getElementById('modal').classList.remove('hidden');
  }

  function editTeacher(id) {
    const t = teachers.find(x => x.id === id);
    if (!t) return showToast('Guru tidak dijumpai', 'error');
    openAddTeacher();
    document.getElementById('modalTitle').textContent = 'Kemaskini Guru';
    document.getElementById('t_id').value = t.id;
    document.getElementById('t_name').value = t.name;
    document.getElementById('t_ic').value = t.ic || '';
    document.getElementById('t_subject').value = t.subject || '';
    document.getElementById('t_phone').value = t.phone || '';
  }

  async function saveTeacher() {
    const id = document.getElementById('t_id').value;
    const teacher = {
      id: id || undefined,
      name: document.getElementById('t_name').value.trim(),
      ic: document.getElementById('t_ic').value.trim() || null,
      subject: document.getElementById('t_subject').value.trim() || null,
      phone: document.getElementById('t_phone').value.trim() || null
    };
    if (!teacher.name) return showToast('Nama diperlukan', 'error');
    try {
      if (id) await apiCall('updateTeacher', { teacher });
      else await apiCall('addTeacher', { teacher });
      closeModal();
      await loadTeachers();
      showToast('Guru berjaya disimpan');
    } catch (err) {
      showToast(err.message, 'error');
    }
  }

  async function deleteTeacher(id) {
    if (!confirm('Padam guru ini?')) return;
    try {
      await apiCall('deleteTeacher', { id });
      await loadTeachers();
      showToast('Guru dipadam');
    } catch (err) {
      showToast(err.message, 'error');
    }
  }

  // === KAKITANGAN ===
  async function loadStaff() {
    try {
      const res = await apiCall('getStaff');
      staff = res.staff || [];
      const tbody = document.querySelector('#staffTable tbody');
      tbody.innerHTML = '';
      staff.forEach(s => {
        tbody.innerHTML += `
          <tr>
            <td>${s.id}</td><td>${s.name}</td><td>${s.ic || '-'}</td><td>${s.position || '-'}</td><td>${s.phone || '-'}</td>
            <td>
              <button class="btn btn-edit" onclick="editStaff('${s.id}')">Kemaskini</button>
              <button class="btn btn-danger" onclick="deleteStaff('${s.id}')">Padam</button>
            </td>
          </tr>`;
      });
    } catch (err) {
      showToast(err.message, 'error');
    }
  }

  function openAddStaff() {
    document.getElementById('modalTitle').textContent = 'Tambah Kakitangan';
    document.getElementById('dataForm').innerHTML = `
      <div class="form-group"><label>Nama</label><input type="text" id="staff_name" required></div>
      <div class="form-group"><label>No. KP</label><input type="text" id="staff_ic"></div>
      <div class="form-group"><label>Jawatan</label><input type="text" id="staff_position"></div>
      <div class="form-group"><label>No. HP</label><input type="text" id="staff_phone"></div>
      <input type="hidden" id="staff_id">
    `;
    currentSaveFunction = saveStaff;
    document.getElementById('modal').classList.remove('hidden');
  }

  function editStaff(id) {
    const s = staff.find(x => x.id === id);
    if (!s) return showToast('Kakitangan tidak dijumpai', 'error');
    openAddStaff();
    document.getElementById('modalTitle').textContent = 'Kemaskini Kakitangan';
    document.getElementById('staff_id').value = s.id;
    document.getElementById('staff_name').value = s.name;
    document.getElementById('staff_ic').value = s.ic || '';
    document.getElementById('staff_position').value = s.position || '';
    document.getElementById('staff_phone').value = s.phone || '';
  }

  async function saveStaff() {
    const id = document.getElementById('staff_id').value;
    const staffItem = {
      id: id || undefined,
      name: document.getElementById('staff_name').value.trim(),
      ic: document.getElementById('staff_ic').value.trim() || null,
      position: document.getElementById('staff_position').value.trim() || null,
      phone: document.getElementById('staff_phone').value.trim() || null
    };
    if (!staffItem.name) return showToast('Nama diperlukan', 'error');
    try {
      if (id) await apiCall('updateStaff', { staff: staffItem });
      else await apiCall('addStaff', { staff: staffItem });
      closeModal();
      await loadStaff();
      showToast('Kakitangan berjaya disimpan');
    } catch (err) {
      showToast(err.message, 'error');
    }
  }

  async function deleteStaff(id) {
    if (!confirm('Padam kakitangan ini?')) return;
    await apiCall('deleteStaff', { id });
    await loadStaff();
    showToast('Kakitangan dipadam');
  }

  // === KELAS ===
  async function loadClasses() {
    try {
      const res = await apiCall('getClasses');
      classes = res.classes || [];
      const tbody = document.querySelector('#classTable tbody');
      tbody.innerHTML = '';
      classes.forEach(c => {
        tbody.innerHTML += `
          <tr>
            <td>${c.id}</td><td>${c.name}</td><td>${c.teacher || '-'}</td>
            <td>
              <button class="btn btn-edit" onclick="editClass('${c.id}')">Kemaskini</button>
              <button class="btn btn-danger" onclick="deleteClass('${c.id}')">Padam</button>
            </td>
          </tr>`;
      });
    } catch (err) {
      showToast(err.message, 'error');
    }
  }

  function openAddClass() {
    document.getElementById('modalTitle').textContent = 'Tambah Kelas';
    document.getElementById('dataForm').innerHTML = `
      <div class="form-group"><label>Nama Kelas</label><input type="text" id="class_name" required></div>
      <div class="form-group"><label>Guru Kelas</label><input type="text" id="class_teacher"></div>
      <input type="hidden" id="class_id">
    `;
    currentSaveFunction = saveClass;
    document.getElementById('modal').classList.remove('hidden');
  }

  function editClass(id) {
    const c = classes.find(x => x.id === id);
    if (!c) return showToast('Kelas tidak dijumpai', 'error');
    openAddClass();
    document.getElementById('modalTitle').textContent = 'Kemaskini Kelas';
    document.getElementById('class_id').value = c.id;
    document.getElementById('class_name').value = c.name;
    document.getElementById('class_teacher').value = c.teacher || '';
  }

  async function saveClass() {
    const id = document.getElementById('class_id').value;
    const cls = {
      id: id || undefined,
      name: document.getElementById('class_name').value.trim(),
      teacher: document.getElementById('class_teacher').value.trim() || null
    };
    if (!cls.name) return showToast('Nama kelas diperlukan', 'error');
    try {
      if (id) await apiCall('updateClass', { cls });
      else await apiCall('addClass', { cls });
      closeModal();
      await loadClasses();
      showToast('Kelas berjaya disimpan');
    } catch (err) {
      showToast(err.message, 'error');
    }
  }

  async function deleteClass(id) {
    if (!confirm('Padam kelas ini?')) return;
    await apiCall('deleteClass', { id });
    await loadClasses();
    showToast('Kelas dipadam');
  }

  // === JADUAL ===
  async function loadSchedule() {
    try {
      const res = await apiCall('getSchedule');
      schedule = res.schedule || Array(5).fill().map(() => Array(5).fill(''));
      document.querySelectorAll('#scheduleTable input').forEach(inp => {
        const r = inp.dataset.row;
        const c = inp.dataset.col;
        inp.value = schedule[r][c] || '';
      });
    } catch (err) {
      showToast(err.message, 'error');
    }
  }

  async function saveSchedule() {
    const newSchedule = Array(5).fill().map(() => Array(5).fill(''));
    document.querySelectorAll('#scheduleTable input').forEach(inp => {
      const r = inp.dataset.row;
      const c = inp.dataset.col;
      newSchedule[r][c] = inp.value.trim();
    });
    try {
      await apiCall('saveSchedule', { schedule: newSchedule });
      showToast('Jadual berjaya disimpan');
    } catch (err) {
      showToast(err.message, 'error');
    }
  }

  function loadViewSchedule() {
    const tbody = document.getElementById('viewScheduleTable').querySelector('tbody');
    tbody.innerHTML = '';
    const times = ['8:00-9:00', '9:00-10:00', '10:00-11:00', '11:00-12:00', '12:00-13:00'];
    times.forEach((time, i) => {
      let tr = `<tr><td>${time}</td>`;
      for (let j = 0; j < 5; j++) tr += `<td>${schedule[i][j] || '-'}</td>`;
      tr += `</tr>`;
      tbody.innerHTML += tr;
    });
  }

  // === LAPORAN MENGAJAR ===
  async function loadTeachingReports() {
    try {
      const res = await apiCall('getTeachingReports');
      const reports = res.reports || [];
      const tbody = document.querySelector('#teachingReportTable tbody');
      tbody.innerHTML = '';
      reports.forEach((r, i) => {
        tbody.innerHTML += `
          <tr>
            <td>${i+1}</td><td>${r.guru}</td><td>${r.date}</td><td>${r.kelas}</td><td>${r.topic}</td><td>${r.notes}</td>
          </tr>`;
      });
      document.getElementById('printDate').textContent = new Date().toLocaleDateString('ms-MY');
    } catch (err) {
      showToast(err.message, 'error');
    }
  }

  async function saveTeachingReport() {
    const date = document.getElementById('reportDate').value;
    const kelas = document.getElementById('reportClass').value;
    const topic = document.getElementById('reportTopic').value.trim();
    const notes = document.getElementById('reportNotes').value.trim();
    if (!date || !kelas || !topic || !notes) return showToast('Isi semua medan', 'error');
    try {
      await apiCall('addTeachingReport', { guru: currentUser.name || currentUser.username, date, kelas, topic, notes });
      showToast('Laporan berjaya dihantar');
      document.getElementById('reportTopic').value = '';
      document.getElementById('reportNotes').value = '';
    } catch (err) {
      showToast(err.message, 'error');
    }
  }

  // === PENCAAPAIAN PELAJAR ===
  function openAddAchievement() {
    document.getElementById('modalTitle').textContent = 'Tambah Pencapaian';
    document.getElementById('dataForm').innerHTML = `
      <div class="form-group"><label>Pelajar</label><input type="text" id="a_student" required></div>
      <div class="form-group"><label>Pencapaian</label><input type="text" id="a_achievement" required></div>
      <div class="form-group"><label>Tarikh</label><input type="date" id="a_date" required></div>
      <input type="hidden" id="a_id">
    `;
    document.getElementById('a_date').valueAsDate = new Date();
    currentSaveFunction = saveAchievement;
    document.getElementById('modal').classList.remove('hidden');
  }

  async function loadAchievements() {
    try {
      const res = await apiCall('getAchievements');
      const achievements = res.achievements || [];
      const tbody = document.querySelector('#achievementTable tbody');
      tbody.innerHTML = '';
      achievements.forEach(a => {
        tbody.innerHTML += `
          <tr>
            <td>${a.student}</td><td>${a.achievement}</td><td>${a.date}</td>
            <td><button class="btn btn-danger" onclick="deleteAchievement('${a.id}')">Padam</button></td>
          </tr>`;
      });
    } catch (err) {
      showToast('Tiada data pencapaian', 'error');
    }
  }

  async function saveAchievement() {
    const id = document.getElementById('a_id').value;
    const achievement = {
      id: id || undefined,
      student: document.getElementById('a_student').value.trim(),
      achievement: document.getElementById('a_achievement').value.trim(),
      date: document.getElementById('a_date').value
    };
    if (!achievement.student || !achievement.achievement || !achievement.date) return showToast('Isi semua medan', 'error');
    try {
      if (id) await apiCall('updateAchievement', { achievement });
      else await apiCall('addAchievement', { achievement });
      closeModal();
      await loadAchievements();
      showToast('Pencapaian berjaya disimpan');
    } catch (err) {
      showToast(err.message, 'error');
    }
  }

  async function deleteAchievement(id) {
    if (!confirm('Padam pencapaian ini?')) return;
    await apiCall('deleteAchievement', { id });
    await loadAchievements();
    showToast('Pencapaian dipadam');
  }

  // Simpan Dinamik
  document.getElementById('saveBtn').onclick = () => {
    if (currentSaveFunction) currentSaveFunction();
  };

  window.onload = () => {
    const theme = localStorage.getItem('theme') || 'light';
    document.documentElement.setAttribute('data-theme', theme);
    document.getElementById('themeIcon').className = theme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
  };
</script>
</body>
</html>
